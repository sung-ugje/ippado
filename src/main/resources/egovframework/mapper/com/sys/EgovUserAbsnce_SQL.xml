<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="userAbsnce">

    <resultMap id="userAbsnce" type="egovframework.ippado.sys.user.service.UserAbsnceVO">
        <result property="userId" column="USER_ID"/>
        <result property="userNm" column="USER_NM"/>
        <result property="userAbsnceAt" column="USER_ABSNCE_AT"/>
        <result property="regYn" column="REG_YN"/>
        <result property="lastUpdusrId" column="LAST_UPDUSR_ID"/>
        <result property="lastUpdusrPnttm" column="LAST_UPDT_PNTTM"/>
    </resultMap>

    <select id="selectUserAbsnceList" parameterType="egovframework.ippado.sys.user.service.UserAbsnceVO" resultMap="userAbsnce">
            SELECT X.USER_ID,
                   X.USER_NM,
                   X.USER_ABSNCE_AT,
                   X.REG_YN,
                   X.LAST_UPDUSR_ID,
                   X.LAST_UPDT_PNTTM
              FROM (SELECT  A.USER_ID, 
                            A.USER_NM,
                           (CASE WHEN B.USER_ABSNCE_AT IS NULL THEN 'N'
                                 ELSE B.USER_ABSNCE_AT 
                             END) AS USER_ABSNCE_AT,
                           (CASE WHEN B.USER_ABSNCE_AT IS NULL THEN 'N'
                                 ELSE 'Y' 
                             END) AS REG_YN,  
                            LAST_UPDUSR_ID,
                            LAST_UPDT_PNTTM
                      FROM  IPD_MBER A LEFT OUTER JOIN LETTNUSERABSNCE B
                        ON  A.USER_ID = B.USER_ID
                   ) X
             WHERE 1 = 1
             <if test="searchCondition == 1">	<![CDATA[	AND
                 X.USER_NM LIKE CONCAT('%' , #{searchKeyword}, '%')	]]>
             </if>
             <if test='selAbsnceAt != "A"'> AND
             	 X.USER_ABSNCE_AT = #{selAbsnceAt}
             </if>
             
             
            ORDER BY LAST_UPDT_PNTTM DESC
            LIMIT #{recordCountPerPage} OFFSET #{firstIndex}  
            
    </select>

    <select id="selectUserAbsnceListTotCnt" parameterType="egovframework.ippado.sys.user.service.UserAbsnceVO" resultType="int">
            SELECT COUNT(*) totcnt
              FROM (SELECT  A.USER_ID, 
                            A.USER_NM,
                           (CASE WHEN B.USER_ABSNCE_AT IS NULL THEN 'N'
                                 ELSE B.USER_ABSNCE_AT 
                             END) AS USER_ABSNCE_AT,
                           (CASE WHEN B.USER_ABSNCE_AT IS NULL THEN 'N'
                                 ELSE 'Y' 
                             END) AS REG_YN,  
                            LAST_UPDUSR_ID,
                            LAST_UPDT_PNTTM
                      FROM  IPD_MBER A LEFT OUTER JOIN LETTNUSERABSNCE B
                        ON  A.USER_ID = B.USER_ID
                   ) X
             WHERE 1 = 1
            <if test="searchCondition == 1"> AND
                X.USER_NM LIKE CONCAT('%' , #{searchKeyword}, '%') 
            </if>
            <if test='selAbsnceAt != "A"'> AND
            	X.USER_ABSNCE_AT = #{selAbsnceAt}
            </if>
                      
    </select>
    
    <select id="selectUserAbsnce" parameterType="egovframework.ippado.sys.user.service.UserAbsnceVO" resultMap="userAbsnce">
            SELECT A.USER_ID, 
                   A.USER_NM,
                   (CASE WHEN B.USER_ABSNCE_AT IS NULL THEN 'N'
                         ELSE B.USER_ABSNCE_AT 
                     END) AS USER_ABSNCE_AT,
                   (CASE WHEN B.USER_ABSNCE_AT IS NULL THEN 'N'
                         ELSE 'Y' 
                     END) AS REG_YN,                     
                   LAST_UPDUSR_ID,
                   LAST_UPDT_PNTTM
              FROM IPD_MBER A LEFT OUTER JOIN LETTNUSERABSNCE B
                ON A.USER_ID = B.USER_ID
              WHERE 1 = 1
                AND A.USER_ID = #{userId}
    </select>
    
    <insert id="insertUserAbsnce" parameterType="egovframework.ippado.sys.user.service.UserAbsnce">
            INSERT INTO LETTNUSERABSNCE (
                        USER_ID,
                        USER_ABSNCE_AT,
                        FRST_REGISTER_ID,
                        FRST_REGIST_PNTTM,
                        LAST_UPDUSR_ID,
                        LAST_UPDT_PNTTM ) 
                VALUES (#{userId},
                        #{userAbsnceAt},
                        #{lastUpdusrId},
                        now(),
                        #{lastUpdusrId},
                        now())
    </insert>    
    
    <update id="updateUserAbsnce" parameterType="egovframework.ippado.sys.user.service.UserAbsnce">
            UPDATE LETTNUSERABSNCE
               SET USER_ABSNCE_AT = #{userAbsnceAt},
                   LAST_UPDUSR_ID = #{lastUpdusrId},
                   LAST_UPDT_PNTTM = now()
             WHERE USER_ID = #{userId}
    </update>    
    
    <delete id="deleteUserAbsnce" parameterType="egovframework.ippado.sys.user.service.UserAbsnce">
        
            DELETE FROM LETTNUSERABSNCE 
             WHERE USER_ID = #{userId}  
        
    </delete>  
        
</mapper>